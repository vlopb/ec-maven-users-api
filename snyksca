pipeline {
  agent none

  environment {
    SNYK_ORG = 'josealdotrucios' // tu org/slug en Snyk
  }

  stages {
    stage('Build') {
      agent { docker { image 'maven:3.9.6-eclipse-temurin-17' } }
      steps {
        sh 'mvn -B -DskipTests verify'
      }
      post {
        success {
          archiveArtifacts artifacts: 'target/*.jar', fingerprint: true, onlyIfSuccessful: true
        }
      }
    }

    // ======== SCA con el PLUGIN (snykSecurity) ========
    stage('Snyk Open Source (Plugin) - Report only') {
        agent { docker { image 'maven:3.9.6-eclipse-temurin-17' } }      
        steps {
            script {
                snykSecurity(
                    organisation: "${SNYK_ORG}",
                    projectName: "${JOB_NAME}",
                    severity: 'medium',                 // umbral de severidad mostrado
                    monitorProjectOnBuild: true,      // hace 'snyk monitor' automáticamente
                    failOnIssues: false,              // NO romper el build por hallazgos
                    failOnError: true,                // sí fallar si hay errores de ejecución
                    snykInstallation: 'snyk@latest',  // nombre en Manage Jenkins > Tools
                    snykTokenId: 'organisation-snyk-api-token', // credencial tipo "Snyk API Token"
                    targetFile: 'pom.xml'            // o déjalo vacío para autodetección
                )
            }
        }
    }
  }
}
